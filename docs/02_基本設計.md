# 基本設計書 - リアルタイムチャットアプリケーション

## 全体アーキテクチャ

### システム構成図
```
[クライアント（ブラウザ）]
         ↕ WebSocket/HTTP
[Vercelサーバーレス環境]
    ├─ Static Files (HTML/CSS/JS)
    ├─ API Functions
    └─ WebSocket Handler
         ↕
[メモリ内データストア]
    ├─ アクティブ接続管理
    ├─ ユーザー情報
    └─ メッセージ履歴
```

### 技術スタック
- **フロントエンド**: HTML5, CSS3, TypeScript, Socket.IO Client
- **バックエンド**: Node.js, Socket.IO Server, Vercel Functions
- **デプロイ**: Vercel
- **リアルタイム通信**: Socket.IO（WebSocket + ポーリング フォールバック）

## モジュール構成

### サーバーサイド構成
```
server/
├── api/
│   └── socket.ts          # Socket.IO ハンドラー
├── lib/
│   ├── socketManager.ts   # 接続管理
│   ├── messageStore.ts    # メッセージ管理
│   └── userManager.ts     # ユーザー管理
└── types/
    └── chat.ts           # 型定義
```

### クライアントサイド構成
```
public/
├── index.html            # メインHTML
├── css/
│   └── styles.css       # スタイルシート
├── js/
│   ├── chat.ts         # チャット機能メイン
│   ├── socket.ts       # Socket.IO クライアント
│   └── ui.ts           # UI操作
└── types/
    └── chat.ts         # クライアント型定義
```

## 外部インタフェース

### WebSocket API

#### 接続イベント
```typescript
// クライアント → サーバー
interface JoinRoomEvent {
  event: 'join-room';
  data: {
    nickname: string;
  };
}

// サーバー → クライアント
interface UserJoinedEvent {
  event: 'user-joined';
  data: {
    nickname: string;
    timestamp: string;
  };
}
```

#### メッセージイベント
```typescript
// クライアント → サーバー
interface SendMessageEvent {
  event: 'send-message';
  data: {
    message: string;
  };
}

// サーバー → クライアント
interface ReceiveMessageEvent {
  event: 'receive-message';
  data: {
    id: string;
    nickname: string;
    message: string;
    timestamp: string;
  };
}
```

#### 状態更新イベント
```typescript
// サーバー → クライアント
interface UpdateUsersEvent {
  event: 'update-users';
  data: {
    users: string[];
  };
}

interface UserLeftEvent {
  event: 'user-left';
  data: {
    nickname: string;
    timestamp: string;
  };
}
```

### HTTP API
- `GET /` - 静的ファイル配信
- `POST /api/socket` - Socket.IO エンドポイント

## データモデル概略

### ユーザー情報
```typescript
interface User {
  id: string;           // Socket ID
  nickname: string;     // 表示名
  joinedAt: Date;      // 参加日時
}
```

### メッセージ
```typescript
interface Message {
  id: string;          // メッセージID（UUID）
  userId: string;      // 送信者ID
  nickname: string;    // 送信者ニックネーム
  message: string;     // メッセージ内容
  timestamp: Date;     // 送信日時
}
```

### チャットルーム状態
```typescript
interface ChatRoom {
  users: Map<string, User>;      // アクティブユーザー
  messages: Message[];           // メッセージ履歴（最新100件）
  maxUsers: number;              // 最大参加者数
  maxMessages: number;           // 最大メッセージ数
}
```

## エラーハンドリング方針

### クライアントサイドエラー
- **接続エラー**: 自動再接続（最大5回、指数バックオフ）
- **送信エラー**: ユーザーに通知、再送オプション提供
- **バリデーションエラー**: 入力フォームでリアルタイム検証

### サーバーサイドエラー
- **Socket接続エラー**: ログ記録、クライアントに汎用エラー返却
- **メッセージ処理エラー**: エラーログ記録、処理継続
- **リソース制限エラー**: 適切なHTTPステータス返却

### エラーレスポンス形式
```typescript
interface ErrorResponse {
  event: 'error';
  data: {
    code: string;
    message: string;
    details?: any;
  };
}
```

## ログ・監視方針

### ログレベル
- **ERROR**: システムエラー、予期しない例外
- **WARN**: リソース制限到達、不正な操作
- **INFO**: 接続・切断、メッセージ送信統計
- **DEBUG**: 詳細な処理フロー（開発時のみ）

### 監視項目
- アクティブ接続数
- メッセージ送信レート
- エラー発生率
- レスポンス時間

### ログ出力例
```typescript
// 接続ログ
logger.info('User joined', { 
  socketId: socket.id, 
  nickname: data.nickname,
  timestamp: new Date().toISOString()
});

// エラーログ
logger.error('Message validation failed', {
  socketId: socket.id,
  error: validationError,
  messageData: data
});
```

## セキュリティ方針

### 入力検証
- ニックネーム: 1-20文字、英数字・日本語のみ
- メッセージ: 1-500文字、HTMLタグエスケープ
- 送信頻度制限: 1秒に最大3メッセージ

### XSS対策
- 全ユーザー入力をHTMLエスケープ
- Content-Security-Policy ヘッダー設定
- innerHTML使用禁止、textContent使用

### DoS対策
- IPアドレス単位でのレート制限
- メッセージサイズ制限
- 接続数制限（50同時接続）

### その他
- HTTPS通信強制
- セキュアクッキー設定
- 機密情報のログ出力禁止

## 非機能要件への対応

### 性能要件
- **レスポンス時間**: Socket.IO自動最適化、Keep-Alive使用
- **スループット**: メモリ内処理でI/O最小化
- **同時接続**: Vercel制限内での最適化

### 可用性
- **冗長化**: Vercelプラットフォームレベルで提供
- **フェイルオーバー**: Socket.IO自動再接続機能
- **ヘルスチェック**: 基本的な生存確認API

### 拡張性
- **水平スケール**: Vercel Functionsでの自動スケール
- **機能拡張**: モジュール分割による保守性確保
- **データ永続化**: 将来のDB連携を考慮した設計

### 運用性
- **デプロイ**: Vercel自動デプロイメント
- **ログ**: Vercelログサービス使用
- **監視**: 基本メトリクス取得
- **バックアップ**: 永続データなしのためスキップ