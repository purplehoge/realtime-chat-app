# claude.md

このリポジトリでの開発と運用の基本方針をまとめる
すべて日本語でやり取りする

---

## 開発モデル
ウォーターフォールを基本とする
上流から順に合意して先に進む

1. 要件定義
2. 基本設計
3. 詳細設計
4. 実装
5. テスト
6. リリース
7. 保守

各工程でレビューと合意を行う
差戻しは可能だが原則として前工程の文書を更新してから次工程を進める

---

## ドキュメント成果物
以下の3点は必ず Markdown で残す
リポジトリ直下に `docs/` を作成

- `docs/01_要件定義.md`
- `docs/02_基本設計.md`
- `docs/03_詳細設計.md`

さらに、**作成した成果物ごとに README.md を作成すること**。成果物の概要、利用方法、依存関係、注意事項などを簡潔にまとめる。

### 要件定義.md テンプレート
- 背景 目的
- スコープ 非スコープ
- 利害関係者
- 前提 制約
- 用語定義
- ユースケース一覧
- 受け入れ基準
- 品質要求 NFR（性能 可用性 セキュリティ 保守性 観測性）
- リスクと対応

### 基本設計.md テンプレート
- 全体アーキテクチャ
- モジュール構成 図
- 外部インタフェース API 画面
- データモデル概略 ER 図
- エラー ハンドリング方針
- ログ 監視方針
- セキュリティ方針
- 非機能要件への対応

### 詳細設計.md テンプレート
- クラス モジュール単位の責務
- 入出力 例外 前後条件
- データ構造とアルゴリズム
- 擬似コードまたはシーケンス図
- SQL スキーマ DDL 差分
- 設定値 環境依存の扱い
- テスト観点 ユニット結合 E2E

---

## 作業前チェックリスト
- 目的 課題の整理ができている
- 影響範囲の仮説を持てている
- 先に `claude.md` を読み直した
- 対応後の確認方法が決まっている
- 必要なら上流ドキュメントを更新する準備ができている

---

## バグ修正の方針
バグ修正時は慌てない 落ち着いて全体を見る

1. 事象の再現手順を最小化
2. 既知仕様かを確認 要件 定義に照合
3. ソース全体を俯瞰 検索 静的解析 依存関係を確認
4. 影響範囲を洗い出し
5. まず設計文書を更新 その後にコードを直す
6. テストを先に用意 追加 既存も更新
7. ロールバック手段を準備
8. 差分説明を作成しレビューへ

### 影響範囲チェック
- 仕様振る舞い 入出力 契約
- 例外とエラーコード
- データモデル 永続化 既存データ移行
- 公開 API 画面 CLI バッチ
- 依存ライブラリとバージョン
- 性能 メモリ スループット
- セキュリティ 権限 ログ 個人情報
- 運用 監視 アラート SLO

---

## 変更の説明 ルール
変更時は変更前と変更後を明確に示す 余計な表現は避ける

**提出物**
- 目的となぜ今直すのか
- Before と After の要約
- 影響範囲と互換性
- テスト内容と結果
- リスクと回避策 ロールバック手順

**差分の書き方**
```diff
# 例: Null チェックの欠落を修正
- function greet(name) {
-   return 'Hello ' + name.toUpperCase()
- }
+ function greet(name) {
+   if (name == null) return 'Hello'
+   return 'Hello ' + String(name).toUpperCase()
+ }
```

**説明テンプレート**
- 目的: 例) Null 入力で例外となるため防止
- Before: name が null で例外 発生箇所 greet
- After: null は 'Hello' を返す 既存挙動は維持
- 影響: 呼び出し元 A B C を確認 互換性あり
- テスト: ユニット3件 結合1件 すべて緑
- リスク: 想定外型の入力 追加ログで監視 すぐ戻せる

---

## 余分なライブラリと関数呼び出しの扱い
外部ライブラリ追加は最後の手段とする 前後の処理を見直して回避を検討

**採用判断の基準**
- 標準機能で代替できない
- 既存依存と重複しない
- メンテナンス継続が見込める ライセンス適合
- バンドルサイズ 運用負荷が許容内

**関数呼び出しの見直し**
- 呼び出し層が適切か
- 単一責務か
- 前後条件 例外 契約が明確か
- キャッシュ リトライ タイムアウトの要否

採用するなら基本設計 詳細設計を更新してから実装する

---

## ファイル分割とコード整理の指針

### 保守性向上のための分割ルール
**原則**: 単一HTMLファイルでの全実装は保守性に問題があるため分割を推進する

**分割の基準**
- HTMLファイル内のコードが1000行を超えた場合は分割検討
- CSS、JavaScript、Python などの処理が混在している場合は分割必須
- 機能単位での責任分離が困難になった場合は分割実施

### ファイル分割の構成例
```
project/
├── index.html              # 基本HTML構造のみ
├── css/
│   ├── styles.css          # メインスタイル
│   └── responsive.css      # レスポンシブ対応（必要時）
├── js/
│   ├── config.js          # 設定・定数
│   ├── game.js            # メインゲームロジック
│   └── utils.js           # 共通ユーティリティ（必要時）
├── python/                 # サーバーサイド処理（必要時）
│   ├── api.py             # API処理
│   └── utils.py           # Python共通処理
└── docs/                   # 設計書類
    ├── 01_要件定義.md
    ├── 02_基本設計.md
    └── 03_詳細設計.md
```

### 分割時の留意点
**HTML**
- 基本構造とコンテンツのみ記述
- 外部CSSとJSファイルのリンクのみ記述
- インラインスタイルとスクリプトは禁止

**CSS分割**
- 機能別・コンポーネント別に分割検討
- レスポンシブ対応は別ファイルも選択肢
- 重複するスタイル定義を避ける

**JavaScript分割**
- 設定・定数は独立ファイル（config.js）
- メインロジックと補助機能を分離
- グローバル変数の競合を避ける

**依存関係の管理**
- ファイル読み込み順序を明確化
- 相互依存関係を最小限に抑制
- 必要に応じてモジュール化検討

### 移行手順
1. 既存の単一ファイルをバックアップ
2. 機能別にコードを抽出・整理
3. 新しいファイル構成で動作確認
4. リファクタリングで品質向上
5. ドキュメント更新（README.md等）

この指針により、保守性・可読性・拡張性の向上を図る

---

## コミットとレビュー
**コミット規約**
- 小さく意味のある単位に分ける
- Conventional Commits を参考にする
  - feat fix refactor docs test chore build ci
- タイトルは 50 文字程度 本文で背景と影響

**PR テンプレート**
- 目的 背景
- Before / After 要約
- 影響範囲 互換性
- テスト内容 結果
- スクリーンショットやログがあれば添付
- 関連ドキュメントへのリンク

**レビュー観点**
- 要件と設計に沿っている
- 影響範囲が説明されている
- 差分が読みやすい 変更理由が明確
- 余計な依存が増えていない
- テストが十分 再現手順が明快

---

## 実装とテストの原則
- 例外と境界値を先に押さえる
- ログは必要十分 個人情報は避ける
- 同期 非同期を混ぜない 片方に寄せる
- パフォーマンスよりもまず正しさ
- 自動テストを残す 回帰を防ぐ

## コメント記述の原則
**可読性とメンテナンス性向上のため、人間が理解しやすいコメントを必ず記述する**

### コメント記述ルール
- **関数・メソッド**: 目的、引数、戻り値を日本語で説明
- **クラス**: 責務と主要な機能を説明
- **重要な処理ブロック**: なぜその処理が必要かを説明
- **定数・設定値**: 意味と用途を明記
- **複雑なアルゴリズム**: ステップごとに処理内容を解説

### コメント例
```javascript
/**
 * オブジェクトを指定方向に移動させる
 * @param {number} direction - 移動方向（-1: 左, 1: 右）
 * @returns {boolean} 移動成功時true、衝突時false
 */
move(direction) {
    // 移動先座標を計算
    const newX = this.currentObject.x + direction;
    
    // 境界や既存オブジェクトとの衝突判定
    if (this.isValidPosition(newX, this.currentObject.y)) {
        this.currentObject.x = newX;
        return true;
    }
    return false;
}
```

### コメント品質基準
- **Why（なぜ）**: 処理の目的・理由を重視
- **What（何を）**: 複雑な処理内容の説明
- **How（どのように）**: アルゴリズムの手順説明
- **注意事項**: 副作用、制限、依存関係の明記

## UI・UX設計の原則
- **ボタン名称はユーザーが理解しやすい内容にする**
  - 技術的な名称より、ユーザーが何ができるかを明確に示す
  - 例: 「copyFromTemplate」→「メモ内容に日付を付加する」
- **操作の結果を明確にフィードバックする**
  - 成功・失敗・注意事項をアラートで適切に通知
  - エラー時は具体的な対処法を示す
- **一貫性のあるUI要素を使用する**
  - ボタンのスタイル、配色、アイコンの使い方を統一
  - 似た機能は似た見た目・配置にする

---

## 運用とリリース
- リリース手順書を PR に添付
- フィーチャーフラグや段階的公開を検討
- 監視条件を定義 メトリクスとアラート
- ロールバック手順を常に準備

---

## 成果物管理

* 成果物ごとに README.md を作成して残すこと。
* README.md には以下を必ず記載すること:

  * 成果物の目的
  * 前提条件（環境や依存関係など）
  * セットアップ手順
  * 利用方法
  * 注意点や制限事項
* README.md のテンプレートを利用する場合は Claude.md に準拠し、必要に応じてカスタマイズすること。

---

## ルールの核
- 作業の前に必ず `claude.md` を読み直す
- ウォーターフォールの順を守る 文書を先に直す
- 修正前に全体を見て影響を洗い出す
- 修正をgithubにコミットプッシュする際は修正ブランチを作成してから、masterにマージする
- 変更前後をわかりやすく示す
- 余分な依存は増やさない
- 成果物ごとに README.md を作成して残す

---

## 新規プロジェクト開始時の注意事項

### 開発環境の継承
- **GitHub CLI認証**: 既に設定済み（`gh auth login --with-token`完了）
- **自動化スクリプト**: `scripts/create-pr.ps1` を新プロジェクトにコピー可能
- **開発フロー**: 修正ブランチ → プルリクエスト → マージの手順は共通

### 新規プロジェクト用の準備
- **新フォルダ**: 新規プロジェクト用のフォルダを作成
- **CLAUDE.md**: この内容をコピーして新プロジェクトのルートに配置
- **GitHub リポジトリ**: `gh repo create` で新規作成
- **デプロイ**: Vercelアカウント設定済み（GitHub連携完了）

### Vercelデプロイ設定
- **連携**: GitHubアカウントとの連携完了
- **自動デプロイ**: GitHubプッシュでVercel自動更新
- **プレビュー**: プルリクエスト毎にプレビューURL生成

#### 開発用Vercelプロジェクト設定
**デプロイメント保護の無効化手順**
1. Vercelダッシュボード → プロジェクト選択
2. Settings → General → Deployment Protection
3. 「Standard Protection」または「Off」に設定
4. 「Public」にチェックを入れる

**汎用設定テンプレート**
- `vercel.development.json`: 開発用設定テンプレート
- APIエンドポイント認証保護なし
- CORS設定により外部アクセス許可
- 長時間実行許可（最大30秒）

### Gitリポジトリ管理のベストプラクティス

#### ブランチ命名規約
**メインブランチ**: `master` または `main` のプロジェクト統一
- **新規プロジェクト**: GitHubデフォルトの `main` を使用
- **既存プロジェクト**: 既存の `master` を継続使用可能
- **変更する場合**: プロジェクト開始時に決定し、チーム全体で統一

**ブランチ運用ルール**
```bash
# 新規リポジトリ作成時の推奨手順
git branch -M main           # mainブランチに統一
git remote add origin <url>
git push -u origin main

# 既存プロジェクトはそのまま継続
git push -u origin master
```

#### .gitignoreの必須設定
```gitignore
# Development tools - 開発ツール固有ファイル
.claude/
.vscode/
.idea/

# OS generated files - OS固有ファイル
.DS_Store
Thumbs.db

# Environment files - 環境設定ファイル（機密情報）
.env
.env.local

# Dependencies - 依存関係（容量大）
node_modules/

# Build outputs - ビルド成果物
dist/
build/
```

#### ファイル管理の原則
- **アップすべきファイル**: ソースコード、設定ファイル、ドキュメント
- **アップしないファイル**: 開発環境依存、機密情報、ビルド成果物、大容量ファイル
- **CLAUDE.md**: プロジェクト共通ルールなら含める、個人メモなら除外

#### コミット前のチェック習慣
```bash
# コミット前の確認
git status          # 変更ファイル確認
git diff            # 差分確認  
git add <specific>  # 必要なファイルのみ追加
```

---

## CLAUDE.md ファイル同期ルール

### 基本方針
プロジェクト間でのCLAUDE.mdの一貫性を保つため、以下の同期ルールに従う

### 同期手順

**プロジェクト開始時・定期更新時**
1. `C:\develop\CLAUDE.md` の最新版を各プロジェクトフォルダにコピー
2. プロジェクト固有の設定がある場合は、汎用部分のみ上書き更新

```bash
# 最新のCLAUDE.mdを取得
cp "C:/develop/CLAUDE.md" ./CLAUDE.md
```

**汎用的な改善を行った場合**
1. プロジェクトフォルダのCLAUDE.mdで汎用的な改善を実施
2. その改善内容を `C:\develop\CLAUDE.md` にも反映
3. 他のプロジェクトでも同じ改善を適用

```bash
# 改善内容を親フォルダに反映
cp ./CLAUDE.md "C:/develop/CLAUDE.md"
```

### 管理対象の内容
- **同期対象**: 開発プロセス、設計テンプレート、コーディング規約、Git運用ルール
- **プロジェクト固有**: 具体的な技術スタック、デプロイ設定、プロジェクト特有の制約

### 更新タイミング
- 新規プロジェクト開始時
- 月次での定期同期確認
- 重要なプロセス改善実施時
- プロジェクト完了時の知見反映

---

## 付録: Claude への依頼テンプレート
```
目的:
前提:
作業範囲:
参照ドキュメント: 要件定義 基本設計 詳細設計 の該当箇所
期待する出力: 差分説明とテスト観点も含める
禁止事項: 余計なライブラリ追加 仕様の独断変更
```

