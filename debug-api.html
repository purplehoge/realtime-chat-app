<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>API Debug Test - Detailed</title>
    <style>
        body { font-family: monospace; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffe6e6; }
        .success { background: #e6ffe6; }
        button { margin: 5px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Vercel API è©³ç´°ãƒ‡ãƒãƒƒã‚°</h1>
    
    <div>
        <label>API URL:</label>
        <input id="api-url" type="text" value="https://serverclient-4l3syvwmv-gunzips-projects-6efa0cc8.vercel.app/api/chat" style="width: 500px;">
    </div>
    
    <div>
        <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :</label>
        <input id="nickname" type="text" value="DebugUser" placeholder="ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å">
    </div>
    
    <div>
        <button onclick="testJoin()">1. JOIN ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testMessage()">2. MESSAGE ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testPolling()">3. POLLING ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testLeave()">4. LEAVE ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div id="logs"></div>
    
    <script>
        let currentUser = null;
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function makeRequest(method, data = null) {
            const apiUrl = document.getElementById('api-url').value;
            log(`ğŸš€ ${method} Request to: ${apiUrl}`);
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                    log(`ğŸ“¤ Request Body: ${JSON.stringify(data, null, 2)}`);
                }
                
                const response = await fetch(apiUrl, options);
                
                log(`ğŸ“Š Response Status: ${response.status} ${response.statusText}`);
                log(`ğŸ“‹ Response Headers: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}`);
                
                let responseData;
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                    log(`ğŸ“¥ Response Data: ${JSON.stringify(responseData, null, 2)}`, response.ok ? 'success' : 'error');
                } else {
                    responseData = await response.text();
                    log(`ğŸ“¥ Response Text: ${responseData}`, response.ok ? 'success' : 'error');
                }
                
                return { response, data: responseData };
                
            } catch (error) {
                log(`âŒ Request Error: ${error.message}`, 'error');
                log(`âŒ Stack: ${error.stack}`, 'error');
                throw error;
            }
        }
        
        async function testJoin() {
            const nickname = document.getElementById('nickname').value;
            log(`ğŸ”‘ JOIN ãƒ†ã‚¹ãƒˆé–‹å§‹ - User: ${nickname}`);
            
            try {
                const result = await makeRequest('POST', {
                    action: 'join',
                    user: nickname
                });
                
                if (result.data.success) {
                    currentUser = nickname;
                    log(`âœ… JOIN æˆåŠŸ - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${currentUser}`, 'success');
                } else {
                    log(`âŒ JOIN å¤±æ•—`, 'error');
                }
                
            } catch (error) {
                log(`âŒ JOIN ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function testMessage() {
            if (!currentUser) {
                log(`âš ï¸ å…ˆã«JOINãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„`, 'error');
                return;
            }
            
            const message = `ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ - ${new Date().toLocaleTimeString()}`;
            log(`ğŸ’¬ MESSAGE ãƒ†ã‚¹ãƒˆé–‹å§‹ - Message: ${message}`);
            
            try {
                const result = await makeRequest('POST', {
                    action: 'message',
                    user: currentUser,
                    message: message
                });
                
                if (result.data.success) {
                    log(`âœ… MESSAGE æˆåŠŸ`, 'success');
                } else {
                    log(`âŒ MESSAGE å¤±æ•—`, 'error');
                }
                
            } catch (error) {
                log(`âŒ MESSAGE ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function testPolling() {
            log(`ğŸ”„ POLLING ãƒ†ã‚¹ãƒˆé–‹å§‹`);
            
            try {
                const apiUrl = document.getElementById('api-url').value;
                const pollUrl = `${apiUrl}?action=messages&since=0`;
                
                log(`ğŸ”„ Poll URL: ${pollUrl}`);
                
                const result = await makeRequest('GET');
                
                log(`âœ… POLLING å®Œäº†`, 'success');
                
            } catch (error) {
                log(`âŒ POLLING ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function testLeave() {
            if (!currentUser) {
                log(`âš ï¸ å…ˆã«JOINãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„`, 'error');
                return;
            }
            
            log(`ğŸšª LEAVE ãƒ†ã‚¹ãƒˆé–‹å§‹ - User: ${currentUser}`);
            
            try {
                const result = await makeRequest('POST', {
                    action: 'leave',
                    user: currentUser
                });
                
                if (result.data.success) {
                    log(`âœ… LEAVE æˆåŠŸ`, 'success');
                    currentUser = null;
                } else {
                    log(`âŒ LEAVE å¤±æ•—`, 'error');
                }
                
            } catch (error) {
                log(`âŒ LEAVE ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        log('ğŸ”§ API ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†');
    </script>
</body>
</html>